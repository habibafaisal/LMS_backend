userService

import jsonwebtoken from "jsonwebtoken";
import prisma from "../db/db.js";
import { comparePasswords } from "../utils/comparePasswords.js";
import { hashPassword } from "../utils/hashPassword.js";
import { constants } from "../utils/constants.js";

export const createUser = async (data) => {
  const { email, password, role } = data;

  const hashedPassword = await hashPassword(password);
  const normalizedRole = role.toUpperCase();

  const existingUser = await prisma.user.findUnique({
    where: { email },
  });
  if (!email || !password || !role) {
    return {
      type: "Error",
      statusCode: constants.VALIDATION_ERROR,
      message: "All fields (email, password, and role) are required.",
    };
  }

  if (existingUser) {
    return {
      type: "Error",
      statusCode: constants.VALIDATION_ERROR,
      message: "Email already exists",
    };
  }

  if (normalizedRole !== "TEACHER" && normalizedRole !== "STUDENT") {
    return {
      type: "Error",
      statusCode: constants.VALIDATION_ERROR,
      message: "Invalid role",
    };
  }

  const newUser = await prisma.user.create({
    data: { email, password: hashedPassword, role: normalizedRole },
  });

  if (normalizedRole === "TEACHER") {
    await prisma.teacher.create({
      data: {
        user_id: newUser.id,
      },
    });
  } else if (normalizedRole === "STUDENT") {
    await prisma.student.create({
      data: {
        user_id: newUser.id,
      },
    });
  }

  return {
    type: "Success",
    statusCode: 201,
    message: "User created successfully",
    user: newUser,
  };
};

export const login = async (data) => {
  const { email, password } = data;
  if (!email || !password) {
    return {
      type: "Error",
      statusCode: constants.VALIDATION_ERROR,
      message: "All fields (email, password) are required.",
    };
  }
  const user = await prisma.user.findUnique({
    where: { email },
  });
  if (!user) {
    return {
      type: "Error",
      statusCode: constants.NOT_FOUND,
      message: "User not found.",
    };
  }
  const isPasswordValid = await comparePasswords(password, user.password);

  if (!isPasswordValid) {
    return {
      type: "Error",
      statusCode: constants.VALIDATION_ERROR,
      message: "Invalid credentials.",
    };
  }

  const accessToken = jsonwebtoken.sign(
    {
      user: { username: user.username, email: user.email, id: user.id },
    },
    process.env.ACCESS_TOKEN_SECRET,
    { expiresIn: "15m" }
  );

  return {
    type: "Success",
    statusCode: 200,
    user: user,
    message: "Login successful",
    accessToken,
  };
};

// Create Department
export const createDepartment = async (data) => {
  const { department_name } = data;

  if (!department_name) {
    return {
      type: "Error",
      statusCode: constants.VALIDATION_ERROR,
      message: "Department name is required.",
    };
  }

  const newDepartment = await prisma.department.create({
    data: { department_name },
  });

  return {
    type: "Success",
    statusCode: 201,
    message: "Department created successfully",
    department: newDepartment,
  };
};

// Create Batch
export const createBatch = async (data) => {
  const { batch_year } = data;

  if (!batch_year) {
    return {
      type: "Error",
      statusCode: constants.VALIDATION_ERROR,
      message: "Batch year is required.",
    };
  }

  const newBatch = await prisma.batch.create({
    data: { batch_year },
  });

  return {
    type: "Success",
    statusCode: 201,
    message: "Batch created successfully",
    batch: newBatch,
  };
};

// Create Semester
export const createSemester = async (data) => {
  const { semester_name, start_date, end_date } = data;

  if (!semester_name || !start_date || !end_date) {
    return {
      type: "Error",
      statusCode: constants.VALIDATION_ERROR,
      message: "All fields (semester_name, start_date, end_date) are required.",
    };
  }

  const newSemester = await prisma.semester.create({
    data: { semester_name, start_date, end_date },
  });

  return {
    type: "Success",
    statusCode: 201,
    message: "Semester created successfully",
    semester: newSemester,
  };
};

// Enroll Student in Course
export const enrollStudentInCourse = async (data) => {
  const { student_id, course_id, semester_id } = data;

  const enrollment = await prisma.enrollment.create({
    data: {
      student_id,
      course_id,
      semester_id,
      enrollment_date: new Date(),
    },
  });

  return {
    type: "Success",
    statusCode: 201,
    message: "Student enrolled successfully",
    enrollment,
  };
};

// Assign Grade
export const assignGrade = async (data) => {
  const { student_id, course_id, semester_id, grade } = data;

  const newGrade = await prisma.grade.create({
    data: {
      student_id,
      course_id,
      semester_id,
      grade,
    },
  });

  return {
    type: "Success",
    statusCode: 201,
    message: "Grade assigned successfully",
    grade: newGrade,
  };
};



userController

import expressAsyncHandler from "express-async-handler";
import {
  createUser,
  login,
  createDepartment,
  createBatch,
  createSemester,
  enrollStudentInCourse,
  assignGrade,
} from "../services/userService.js";

export const registerUser = expressAsyncHandler(async (req, res) => {
  const { type, message, statusCode, user } = await createUser(req.body);

  if (type === "Error") {
    return res.status(statusCode).json({ type, message });
  }

  res.status(statusCode).json({
    type,
    message,
    user,
  });
});

export const loginUser = expressAsyncHandler(async (req, res) => {
  const { type, message, statusCode, user, accessToken } = await login(req.body);
  if (type === "Error") {
    return res.status(statusCode).json({ type, message });
  }
  res.status(statusCode).json({
    type,
    message,
    user,
    accessToken,
  });
});

export const createDept = expressAsyncHandler(async (req, res) => {
  const { type, message, statusCode, department } = await createDepartment(req.body);

  if (type === "Error") {
    return res.status(statusCode).json({ type, message });
  }

  res.status(statusCode).json({
    type,
    message,
    department,
  });
});

export const createBatch = expressAsyncHandler(async (req, res) => {
  const { type, message, statusCode, batch } = await createBatch(req.body);

  if (type === "Error") {
    return res.status(statusCode).json({ type, message });
  }

  res.status(statusCode).json({
    type,
    message,
    batch,
  });
});

export const createSemester = expressAsyncHandler(async (req, res) => {
  const { type, message, statusCode, semester } = await createSemester(req.body);

  if (type === "Error") {
    return res.status(statusCode).json({ type, message });
  }

  res.status(statusCode).json({
    type,
    message,
    semester,
  });
});

export const enrollStudent = expressAsyncHandler(async (req, res) => {
  const { type, message, statusCode, enrollment } = await enrollStudentInCourse(req.body);

  if (type === "Error") {
    return res.status(statusCode).json({ type, message });
  }

  res.status(statusCode).json({
    type,
    message,
    enrollment,
  });
});

export const assignStudentGrade = expressAsyncHandler(async (req, res) => {
  const { type, message, statusCode, grade } = await assignGrade(req.body);

  if (type === "Error") {
    return res.status(statusCode).json({ type, message });
  }

  res.status(statusCode).json({
    type,
    message,
    grade,
  });
});


userRoutes

import express from "express";
import {
  loginUser,
  registerUser,
  createDept,
  createBatch,
  createSemester,
  enrollStudent,
  assignStudentGrade,
} from "../controllers/userController.js";

const router =

